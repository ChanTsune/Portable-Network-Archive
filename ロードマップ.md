# BSD-tar互換ロードマップ（experimental stdio）

## 0. 参照資料
- bsdtar(1) official manual (macOS 14.7 同等仕様)citeturn8open0
- Portable Network Archive experimental stdio 実装: `cli/src/command/stdio.rs` ほか Rust CLI モジュール

## 1. コマンドラインオプション互換マトリクス
記号: ✅ 完全互換 / ⚠️ 部分互換（名称・挙動要確認）/ ❌ 未対応。`--unstable` 必須な項目は互換観点で課題扱いとする。

### 1.1 モード系（サブコマンド）
| bsdtarオプション | 公式仕様の要約 | experimental stdio 現状 | 実装・課題メモ |
| --- | --- | --- | --- |
| -c / --create | 新しいアーカイブを作成 | ✅ `--create`/`-c` 利用可 | `cli/src/command/stdio.rs:61` 既実装。bsdtar互換のデフォルト挙動（例: `--keep-dir`初期値）検証が今後の確認項目。 |
| -r / --append | 既存アーカイブに追加 | ✅ `-r`/`--append` 利用可 | `cli/src/command/stdio.rs:79`。圧縮フラグ同時指定時は bsdtar 同様にエラー。 |
| -t / --list | アーカイブ一覧表示 | ✅ | `cli/src/command/stdio.rs:65`。`-v` 指定時のbsd形式出力を `ListOptions::format` で制御する必要あり。 |
| -u / --update | 新しい場合のみ更新 | ✅ | `cli/src/command/stdio.rs:91`。圧縮指定はエラーとして拒否。 |
| -x / --extract / --get | アーカイブ展開 | ✅ | `cli/src/command/stdio.rs:63`。`--get` alias 追加、`-O` 連携のストリーム抽出対応が課題。 |
| -d / --delete | アーカイブから削除 | ✅ | `cli/src/command/stdio.rs:97` から `run_delete` を呼び出し済み。 |
| -A / --append-to | 他アーカイブ連結 | ✅ | `cli/src/command/stdio.rs:85` で `run_append_to` に委譲。 |
| @archive | 入力アーカイブ内容を連結 | ⚠️ | `cli/src/command/stdio.rs:602` ほか。ファイル出力時のみサポート（stdout では未対応）。 |

### 1.2 入出力・探索系
| bsdtarオプション | 要約 | 現状 | 実装・課題メモ |
| --- | --- | --- | --- |
| -a / --auto-compress | 拡張子で圧縮推定 | ✅ | `cli/src/command/stdio.rs:1307` の `apply_auto_compress` で拡張子から圧縮方式を推定。 |
| --acls | ACL を保存/復元 | ⚠️ `--keep-acl` 長オプションのみ・`--unstable` 要求 | `cli/src/command/stdio.rs:110`。名称 alias と `--no-acls` 対応が必要。 |
| -B / --read-full-blocks | 完全ブロック読み込み | ⚠️ | 互換のため受理し警告を出すのみ（no-op）。ドキュメントで無効であることを周知。 |
| -b / --block-size | ブロックサイズ指定 | ⚠️ | 互換のため受理して警告を出すのみ。実際のブロック制御は未実装。 |
| -C / --cd / --directory | 作業ディレクトリ変更 | ✅ | `cli/src/command/stdio.rs:223` (`-C` 対応)。抽出時ディレクトリ移動の挙動差を確認。 |
| --chroot | chroot実行 | ❌ | 権限周り要検討。 |
| --clear-nochange-fflags | macOS fflags操作 | ⚠️ | フラグを受理して警告を出すのみ（no-op）。 |
| --exclude pattern | パターン除外 | ⚠️ `--unstable` 必須、glob実装差あり | `cli/src/command/stdio.rs:131`。`--unstable`撤廃と bsdtarパターン準拠（BsdGlobPatterns 追加実装）を行う。 |
| --exclude-vcs | VCSファイル除外 | ⚠️ | `cli/src/command/stdio.rs:627` 等で `--unstable` 不要だが `list` サブコマンドのみ依然 `--unstable` 必須。 |
| --fflags | BSD file flags保持 | ⚠️ | 互換目的で受理し警告を出して無視。実際の保存/復元は未実装。 |
| --format format | フォーマット指定 | ⚠️ 受理のみ | Clap で受理して警告、常に PNA フォーマットで処理。複数フォーマット対応は将来課題。 |
| -f file / --file | アーカイブ入出力先 | ✅ | `cli/src/command/stdio.rs:237`。`@-` など特殊指定の互換性確認。 |
| --gid id | グループID指定 | ✅ | `cli/src/command/stdio.rs:168`。 |
| --gname name | グループ名指定 | ✅ | `cli/src/command/stdio.rs:160`。 |
| -H | コマンドラインのシンボリックリンク追従 | ✅ | `cli/src/command/stdio.rs:142`。互換テスト追加済 (`tests/bats/bsdtar_compat/test_option_H_upper.bats`) だが `--unstable` 依存を解消。 |
| -h | `-L` の別名 | ⚠️ | `--follow-links` は利用可だが `-h` alias 未実装。 |
| -I | `-T` の別名 | ❌ | Clap alias追加。 |
| --help | ヘルプ | ✅ | Clap 自動生成。bsdtar互換の例示差分を表に反映させる。 |
| -k / --keep-old-files | 既存ファイルを保護 | ✅ | `cli/src/command/stdio.rs:188` 以降で `OutputOption.keep_old_files` を利用し上書きを抑止。 |
| --keep-newer-files | 既存の方が新しければ保持 | ✅ | `OutputOption.keep_newer_files` でタイムスタンプ比較を実装済み。 |
| -L / --dereference | シンボリックリンクを辿る | ⚠️ `--follow-links` 長オプションのみ (`--unstable`) | `cli/src/command/stdio.rs:139`。`-L` alias追加。 |
| -l / --check-links | ハードリンク参照数チェック | ✅ | `HardlinkTracker` と `ensure_hardlinks_complete` で参照数を確認し、不足時にエラーを返す。 |
| -P / --absolute-paths | 絶対パスを維持 | ❌ | 抽出時の安全チェックに新フラグを追加し、bsdtar互換の `-P` を導入。 |
| --include pattern | パターン限定 | ⚠️ `--unstable` | `cli/src/command/stdio.rs:126`。互換 glob 実装と alias `--no-ignore-case` 等検討。 |
| --ignore-zeros | ゼロブロック無視 | ✅ | `run_process_archive_with_options` がゼロパディングをスキップし、後続エントリの処理を継続。 |
| --null | NUL区切り入力 | ✅ | `cli/src/command/stdio.rs:245`。`-T -` シナリオでの互換テストが必要。 |
| -T file / --files-from file | ファイル一覧入力 | ⚠️ 長オプションのみ (`--unstable`) | `cli/src/command/stdio.rs:200`。`-T` alias と `--files-from=-` 対応を追加。 |
| -X file / --exclude-from file | 除外リスト | ⚠️ `--unstable` | `cli/src/command/stdio.rs:133`。 |
| --one-file-system | 同一ファイルシステムのみ | ✅ | `collect_items` で `WalkDir::same_file_system` を使用し、CLI からフラグを伝搬。 |
| --nodump | nodump 属性尊重 | ✅ | `collect_items` が nodump フラグ検査 (`has_nodump_flag`) を行い、該当エントリを除外。 |
| --options key=val | フォーマット依存設定 | ⚠️ | Clap で受理するが現状は警告を出して無視（解析のみ）。今後の橋渡しが課題。 |
| --use-compress-program prog | 外部圧縮器 | ⚠️ | フラグを受理して警告を出すのみ。現状は外部コマンドを起動しない。 |

### 1.3 圧縮・暗号・フォーマット指定
| bsdtarオプション | 要約 | 現状 | 実装・課題メモ |
| --- | --- | --- | --- |
| -J / --xz | XZ 圧縮 | ⚠️ `--xz` 長オプションのみ (`CompressionAlgorithmArgs`) | `cli/src/cli.rs:215`。短縮 `-J` alias と自動 `.xz` 拡張連携。 |
| -j / --bzip* | bzip2 圧縮族 | ❌ | 新アルゴリズム追加 or 外部実行。 |
| -y | bzip2 短縮（互換） | ❌ | 上記に連動。 |
| -Z / --compress | compress(1) | ❌ | 実装予定判断。 |
| -z / --gzip / --gunzip | gzip 圧縮 | ❌ | Zlib/deflateは `--deflate` あり。`-z` alias と gzipヘッダ互換出力要検討。 |
| --lrzip | lrzip 圧縮 | ❌ | 対応検討。 |
| --lz4 | lz4 圧縮 | ❌ | 追加アルゴリズム。 |
| --lzma | lzma 圧縮 | ❌ | 追加アルゴリズム。 |
| --lzop | lzop 圧縮 | ❌ | 外部プログラム呼び出し。 |
| --zstd | zstd 圧縮 | ⚠️ `--zstd` 長オプションあり。aliasとbsdtar互換レベル指定（1-19 vs 1-21）確認。 |
| --store | 無圧縮 | ✅ | `cli/src/cli.rs:200`。bsdtar `--format pax`と組み合わせる際の挙動確認。 |
| --deflate | Deflate 圧縮 | ⚠️ `--deflate` 長オプション。`-z` alias対応で互換化。 |
| --auto-compress (-a) | 上掲 | ❌ | 上述参照。 |
| --passphrase | 暗号パスフレーズ | ❌ | `PasswordArgs` は `--password` のみ。互換 alias と passphrase file semantics 整備。 |
| --posix | POSIX (pax) フォーマット | ⚠️ 受理のみ | オプションを受け付けて警告を表示し、内部は PNA フォーマットで処理。互換上の文言をドキュメント化。 |
| -o (c/r/u) | ustar強制 | ⚠️ 受理のみ | Clap alias を追加しつつ PNA フォーマットで処理、挙動をドキュメントに明記。 |
| --format pax/ustar | 上掲 | ❌ | 同上。 |

### 1.4 ファイル選択・時間条件
| bsdtarオプション | 要約 | 現状 | 実装・課題メモ |
| --- | --- | --- | --- |
| -n / --no-recursion | 再帰無効 | ⚠️ `--no-recursive` 長オプションのみ (`--unstable`) | `cli/src/command/stdio.rs:77`。`-n` alias追加。 |
| --newer date | 指定日時より新しいもののみ | ✅ | `build_time_filters` で解析し、`collect_items` と `update` 経路へ反映。`collect_items_respects_mtime_filters` で検証。 |
| --newer-mtime date | mtime基準 | ✅ | 同上。 |
| --newer-than file | 指定ファイルより新しい | ✅ | 参照ファイルの mtime を取得しフィルタ化。 |
| --newer-mtime-than file | mtime基準ファイル | ✅ | 同上。 |
| --older date | 指定日時より古いもののみ | ✅ | `TimeFilters` の `older_than` 比較を経路に追加。 |
| --older-mtime date | mtime基準 | ✅ | 同上。 |
| --older-than file | ファイル比較 | ✅ | 参照ファイルの mtime を読み取りフィルタ。 |
| --older-mtime-than file | mtime比較 | ✅ | 同上。 |
| --strip-components count | パス先頭除去 | ✅ | `cli/src/command/stdio.rs:149`。互換テスト未整備（追加）。 |
| -s pattern | BSD tar 互換のリネーム | ✅ | `cli/src/command/stdio.rs:356` ほかで安定化。`cli/tests/cli/create/substitution.rs` / `extract/substitution.rs` / `stdio/substitution.rs` による回帰で `-s` が `--unstable` 無しで機能することを確認。`--transform` も同様。 |
| --include pattern | 上掲 | ⚠️ | 上掲参照。 |
| --no-safe-writes / --safe-writes | 出力ファイル安全書き込み | ❌ | I/O層に実装追加。 |
| -q / --fast-read | パターン一致で停止 | ❌ | `run_list_archive` / `run_extract_archive` に早期終了ロジック追加。 |
| -w / --confirmation | 操作前確認 | ❌ | 対話UI実装。 |

### 1.5 所有者・パーミッション・メタデータ
| bsdtarオプション | 要約 | 現状 | 実装・課題メモ |
| --- | --- | --- | --- |
| -p / --preserve-permissions | 権限保持 | ✅ | `cli/src/command/*` で `-p` を安定化し、`--no-same-permissions` と併せて `KeepOptions` を制御。`cli/tests/cli/stdio/no_same_permissions.rs` ほかで回帰。 |
| -m / --modification-time | 抽出時にmtimeを現時刻へ | ✅ | `OutputOption.touch_modification_time` で対応し、`cli/tests/cli/stdio/modification_time.rs` で回帰済み。 |
| --same-owner | 所有者復元試行 | ✅ | `cli/src/command/stdio.rs:216`。互換テスト要。 |
| --no-same-owner | 所有者固定 | ✅ | `cli/src/command/stdio.rs:220`。 |
| --numeric-owner | 数値ID保存 | ✅ | `cli/src/command/stdio.rs:174`。 |
| --uid id / --gid id | UID/GID上書き | ✅ | `cli/src/command/stdio.rs:168` など。 |
| --uname name / --gname name | 名前上書き | ✅ | `cli/src/command/stdio.rs:155` 等。 |
| --acls / --no-acls | ACL保存/抑止 | ⚠️ `--keep-acl` のみ／`--no-acls` 未実装 | `cli/src/command/stdio.rs:110`。Opposite flag追加。 |
| --xattrs / --no-xattrs | 拡張属性 | ⚠️ `--keep-xattr` のみ／無効化不可 | `cli/src/command/stdio.rs:104`。 |
| --no-same-permissions | 権限復元を抑止 | ❌ | `KeepOptions` に新フラグを追加し extract 時に chmod をスキップ。 |
| --nodump | 上掲 | ✅ | 同上。 |
| --mac-metadata / --no-mac-metadata / --nopreserveHFSCompression | HFSメタ保持／抑止 | ❌ | macOS固有拡張の扱いと保存形式の調査が必要。 |
| --fflags / --no-fflags | BSD flags | ❌ | Coreサポート要。 |
| --hfsCompression | Apple圧縮保持 | ❌ | 上同。 |
| --same-owner (default) | 上掲 | - | 既に `same_owner` フィールド default true (no same owner false)。挙動確認。 |
| -o (x mode) | 自分のUID/GIDで展開 | ❌ | `OutputOption` に `extract_as_self` 追加（`--no-same-owner` alias?). |

### 1.6 出力・ログ・ユーティリティ
| bsdtarオプション | 要約 | 現状 | 実装・課題メモ |
| --- | --- | --- | --- |
| -O / --to-stdout | 標準出力へ抽出 | ❌ | `run_extract_archive` にストリーム書き出し導入。 |
| -S | スパース抽出 | ❌ | PNA coreで sparse 対応検討。 |
| --totals | 統計表示 | ❌ | `List`/`Extract` に合計表示機能追加。 |
| -U / --unlink-first | 展開前に unlink | ❌ | `OutputOption` 拡張。 |
| -v / --verbose | 冗長出力 | ❌ | グローバル `--verbose` はログ用途。bsdtar互換の `-v` 表示（create/extract/list）を実装。 |
| --version | バージョン表示 | ✅ | Clap (`-V`/`--version`) で出力。バージョン文字列に互換表記追加検討。 |
| --ignore-zeros | 上掲 | ✅ | `Archive` 読み取りでゼロブロックをスキップしつつ継続読み取り。 |
| --safe-writes | 上掲 | ❌ | I/O層実装。 |
| --no-safe-writes | 上掲 | ❌ | 同上。 |
| --to-command | (bsdtar拡張) | - | manualには無いが `--to-command` (GNU) は対象外。 |

## 2. 実装ロードマップ（ツリー）
- 0 準備
  - 0.1 互換モードの CLI 設定整理（`cli/src/cli.rs:34` 付近）
    - 0.1.1 `--unstable` 依存オプションの段階的解除
    - 0.1.2 Clap alias (`-r`, `-T`, `-J`, `-p`, `-n`, `-v` etc.) の一括適用
  - 0.2 公式仕様準拠チェック
    - 0.2.1 本表を GitHub Issue テンプレに転記し状態管理
    - 0.2.2 互換テストケース洗い出し（Bats + Rust unit）
    - 0.2.3 レガシーなハイフン無しオプション（例: `cf` 形式）は Clap 仕様上非対応とし、ドキュメントで明示

- 1 モード拡張
  - 1.1 stdio から `update`/`delete`/`concat`/`diff` を露出
  - 1.2 `append` モードの `-r` alias と圧縮禁止ガード
  - 1.3 `@archive` 書式サポートとテスト整備

- 2 フォーマット・圧縮
  - 2.1 `--format`/`--posix`/`-o`(ustar) の指定 API を PNA コアへ追加
  - 2.2 圧縮ショートカット（`-z/-j/-J/-Z/-y`）と `--auto-compress` 実装
  - 2.3 外部圧縮器 (`--use-compress-program`) インタフェース設計（非同期パイプ＋エラー処理）

- 3 ファイル選択と再帰制御
  - 3.1 `--include/--exclude/--files-from/--null` の bsdtar 互換グロブ・`@`ファイル処理
  - 3.2 `--newer*/--older*`、`--one-file-system`、`--nodump` 対応を `collect_items` に実装
  - 3.3 `--fast-read` 等の早期終了ロジック追加

- 4 属性・メタデータ
  - 4.1 ACL/xattr/FFLAG/HFS オプションのトグル・`--no-*` 対応
  - 4.2 `-p/-m/-o` など抽出時オプション反映 (`OutputOption` 拡張)
  - 4.3 所有者/ID オプションの挙動比較テスト

- 5 出力・UX
  - 5.1 `-v` 互換表示（create/extract/list）と `--totals`
  - 5.2 `-O`／`--to-stdout`、`-U`、`--ignore-zeros` 等の I/O フラグ実装
  - 5.3 対話的フラグ（-w）とエラー／警告メッセージの互換化

- 6 テスト & ドキュメント
  - 6.1 `tests/bats/bsdtar_compat/` に各オプションの回帰テスト追加
    - 6.1.1 同一シナリオを `bsdtar` と `pna experimental stdio` で実行し、終了コード／stdout／stderr／生成物を比較するゴールデン比較ハーネスを整備（差分検出で即失敗）
    - 6.1.2 異常系（存在しないファイル、権限不足、排他オプション衝突など）の期待エラーを網羅し、エラーコードやメッセージの非互換を検出
    - 6.1.3 圧縮形式・所有権操作などプラットフォームにより結果が変わる項目は Linux/macOS 両方で実行し、想定差分のみホワイトリスト化
    - 6.1.4 libarchive の tar コマンド回帰テストスイートを取り込み、互換レイヤで全ケースをパスする（テスト資産は upstream 更新に追従）
  - 6.2 `cli/tests/` に Clap パーサ単体テスト（成功/失敗）
    - 6.2.1 ショートハンド展開や排他制約を網羅し、サポート外（ハイフン無しバンドル等）は明確に "unsupported" を返すかを確認
  - 6.3 回帰テストの自動検出を CI に統合
    - 6.3.1 GitHub Actions で `bsdtar` をセットアップし、ゴールデン比較テストを macOS/Linux 双方で実行
    - 6.3.2 リリース前フローで `--unstable` を外した状態でも全互換テストが通ることを検証
  - 6.4 ドキュメント更新
    - 6.4.1 README・`--help`・リリースノートに互換カバレッジと制限事項を明示
    - 6.4.2 非対応オプション（例: ハイフン無しバンドル、PNA 固有フォーマットのみサポート）を表形式で共有し、ユーザー周知を徹底

## 3. 今後の管理方針
- 本マトリクスを GitHub issue テンプレに転記し、`triage/compat` ラベルでトラッキング
- 未対応項目は Issue 作成 → Milestone「bsdtar互換 v1」へ束ねる
- 完了の定義: 実装 + Bats テスト + ドキュメント更新 + CLI `--help` 反映
