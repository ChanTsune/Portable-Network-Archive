# 実装着手前の確認事項

以下は、`ロードマップ.md` / `todo.md` に基づき作業を開始する前に解決すべき判断ポイントです。各項目にご回答いただければ、以後はノンストップで作業を進められます。

- [ ] **圧縮アルゴリズムの追加範囲**  
  `--lz4` / `--lzma` / `--lzop` / `--lrzip` / `-j`(bzip2) / `-Z`(compress) など、bsdtar がサポートする複数の圧縮方式を実装する際、以下のうちどのアプローチを取るべきでしょうか。  
  - a. 既存の Rust クレート（例: `xz2`, `bzip2`, `lzma-rs`, `lz4_flex` など）を依存関係に追加してネイティブ実装する  
  - b. 可能なものは既存クレートで補い、それ以外は `--use-compress-program` に委ねる  
  - c. すべて外部コマンド呼び出しで対応（`gzip` など）  
  その他方針があれば明示してください。  
  回答: 現時点で対応しているアルゴリズムのみ実装・現時点で対応していないアルゴリズムはzstdにフォールバックする

- [ ] **`--use-compress-program` の許可範囲**  
  任意コマンドを実行可能にする設計で問題ありませんか。それともホワイトリスト方式 / PATH 以外禁止など制約を設けるべきでしょうか。  
  回答:オプション引数自体は受け入れた上で何もしない設計で良い

- [ ] **`--format` / `--posix` / `-o` の扱い**  
  PNA 以外のフォーマットに変換しない旨を警告表示のみで済ませる設計で問題ありませんか。メッセージ文言や終了コードに関する希望があれば教えてください。  
  回答:警告文のみで良いです。終了コードも正常終了で良い

- [ ] **`--block-size` / `--read-full-blocks` / テープデバイス対応**  
  物理テープ用途のブロックサイズ制御をどの程度再現する必要がありますか。擬似的な実装（メモリバッファで固定長読み／書き）で十分か、それとも実際のブロック境界とパディングを完全再現すべきでしょうか。  
  回答:受け入れるのみで何もしない実装で良い

- [ ] **`--chroot` および root 権限が前提となる機能**  
  テスト実行環境で `chroot` や `chflags` など root 権限が必要な操作を許容できますか。それとも疑似実装（Permission Denied を返す等）で整合性を取るべきでしょうか。  
  回答:ルートで実行している前提で良い。rootでなかった場合、それぞれの関数側で返されるエラーを持って異常終了とするので特別なエラーハンドリング等は不要

- [ ] **`--fflags` / `--nodump` / `--mac-metadata` など OS 依存項目**  
  macOS/BSD 固有のファイル属性を PNA フォーマットへどのレベルで保存・復元すべきか指針をください。クロスプラットフォーム互換よりも「対応プラットフォーム限定で動作すれば良い」方針で問題ありませんか。  
  回答:引数を受け入れた上で非対応の警告出す設計で良い

- [ ] **スパースファイル (`-S`) の表現方式**  
  PNA フォーマット内でスパースファイルを表現する既存 API が無い場合、互換層でどの程度まで再現すれば良いでしょうか。例: `--to-command` など別出力も必要ですか。  
  回答:他のPNAフォーマット自体が非対応な機能については、別途私が対応しますので、何が理由で実装できないのか理由を書き残しておいてください。

- [ ] **libarchive テストスイートの活用方法**  
  `scripts/sync-libarchive-tests.sh` で具体的にどのブランチ／タグをターゲットにすべきか、またテスト失敗時の扱い（アップストリーム差分由来の場合の除外方法など）に方針があれば教えてください。  
  回答: ブランチはclone時のデフォルトブランチで良い。GitHubでホストされているlibarchiveのプロジェクトをcloneしてきて中身を解析してtarコマンドを実行するテストを探して実行してください。おそらくtarの代わりにpnaを動かすにあたり、pna experimental stdio をラップするshellスクリプトを噛ませる必要性が生じるので留意しておくこと。

- [ ] **ゴールデン比較テストの許容差分**  
  stdout/stderr/生成物の差分判定で、タイムスタンプや権限の僅かな違いを許容するためのルール（例: 正規化する／特定行を無視する）が必要かどうか指示をお願いします。  
  回答:わずかな違いについては、対応は不要ですが違いがある旨を別途記してください。

- [ ] **`--fast-read` の終了条件**  
  パターンが複数指定された場合は最初の一致で停止すれば良いか、あるいは全一致後に停止すべきかなど、bsdtar と同一挙動に合わせるための詳細仕様を確認したいです。  
  回答:最初の一致で停止して良いです。

- [ ] **`--safe-writes` / `--no-safe-writes` の期待挙動**  
  一時ファイル位置やファイル権限の継承方法など、期待する詳細仕様があれば教えてください。  
  回答:引数を受け入れるのみで何もしない実装で良い。

- [ ] **ハイフン無しバンドルオプションの扱い**  
  Clap 仕様上非対応とする方針は了解しましたが、エラーメッセージの文言や終了コードについて要望があれば教えてください（例: 「未サポート」 vs 「無効なオプション」）。  
  回答:Clapのパースエラーのままで良い。つまり新たに何もしなくていい。

- [ ] **ドキュメント更新の言語・スタイル**  
  README などは日本語／英語どちらで記載すべきでしょうか。現状のプロジェクト方針に合わせたいので指示をお願いします。  
  回答:コード内のコメントを含めて全て英語、ただし、進捗管理のためや状況確認のため私が直接読む必要がある部分は日本語で記すこと。

全体方針：引数を受け入れるのみで何もしないコードは、helpテキストに互換性のために引数を受け入れるが、何もしない旨を明記しておくこと。